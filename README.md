# Интеграция RDESK для AmoCRM
---

## Установка и запуск
---
```bash
git clone https://github.com/dyuzha/amo-services.git

cd amo-services

docker compose up -d # (Должен быть установлен docker)
```

1. Настройка клиентской части.
Создать интеграцию в аккаунте **AmoCRM**  *(публичную или приватную)*.
Для визуализации сводных данных пришедших из **СПК Здравницы**, а также для инициализации данных из **AmoCRM** в **СПК Здравницу**, необходимо воспользоваться виджетом (ссылка на виджет).

2. Установка docker, compose.
3. Установка репозитория.
```bash
git clone https://github.com/dyuzha/amo-services.git
cd amo-services
mv ./docs/example.env .env
```
4. Настройка (ссылка на настройку)
Заполнить .env файл

5. Запуск приложения
```bash
docker compose up -d # (Должен быть установлен docker)
```
6. Настройка автозапуска для **RedHat** дистрибутивов на примере **CentOS 11**.
6.1. Создать пользователя для запуска сервиса.
```bash
useradd -m amo-staff
chmod amo-staff
# *******
```
6.2. Выдать права пользователю на сервис.
```bash
chown -R amo-staff:amo-staff amo-services
```
6.3. Сделать autologon.
```bash

```
6.4. Создать и настроить сервис. (нужно еще unit засунуть в репозиторий)
```bash

```

## Настройка
---

Основные настройки nginx
```bash
NGX_PORT=6000           # (По сути ни на что не влияет)
HOST_PORT=9000          # (Порт на котором будет доступен NGINX из внешки)
NGX_SERVER_NAME=domain.example.ru
SSL_FULLCHAIN_FILE=./path/to/fullchain.file
SSL_KEY_FILE=./path/to/key.file
KEEPALIVE_TIMEOUT=60
```

Определяет шаблон конфигурации, с зеркалированием / без зервкалирования
Опредеяет адрес для зеркалирования (удобно для отладки, можно сделать включить данный режим и параллельно с работой сервиса, тестировать новый функционал с актуальными данными в режим реального времени на стороннем сервере, например на ПК разработчика.)
```bash
# Путь до шаблона
NGX_TEMPLATE_CONF=./nginx/nginx.conf.template
# С режимом зеркалирования (для отладки)
# NGX_TEMPLATE_CONF=./nginx/nginx.mirror-template.conf

# Адрес для зеркалирования
MIRROR_TARGET=https://mirror-domain.example.ru
```

Основные настройки
```bash
# ID интеграции
AMO_CLIENT_ID=

# domain организации (все что до .amocrm.ru)
AMO_SUBDOMAIN=
# Должен совпадать с "ссылкой для перенаправления" (Каждый символ),

# находится в меню редактирования интеграции (первая ссылка).
AMO_REDIRECT_URL=

# Сгенерировать при первом подключении
AMO_CLIENT_SECRET=

# Обновить при необходимости
AMO_AUTH_CODE=
```
2> фотографии!!!!


```bash
# --- APP settings --- #
# Endpoint для каждой воронки (какие endpoint'ы будет слушать сервер)
APP_INCOMING_MC=/zdrav/mc
APP_INCOMING_BOOKED=/zdrav/booked
```


```bash
# Маппинг полей AmoCRM
FIELD_SHARED_CREATED_AT=1287599
FIELD_SHARED_PAID_PRICE=1305167
FIELD_SHARED_ZDRAV_ID=1305111

FIELD_BOOKED_STATUS=1304923
FIELD_BOOKED_CHECK_IN=1305059
FIELD_BOOKED_CHECK_OUT=1305061
FIELD_BOOKED_GUESTS=1304335
FIELD_BOOKED_DOC_NUM=1305107
FIELD_BOOKED_BILL_DATA=1304929
```
Фото


Настройки для тестирования
```bash
# --- Mock settings --- #
# ДАННЫЕ НАСТРОЙКИ БУДУТ ИСПОЛЬЗОВАТЬСЯ ТОЛЬКО ДЛЯ РЕЖИМА ПОДМЕНЫ lead_id.

# Если вы не используете данный режим, данные настройки ни на что не повлияют
# Лучше оставить закоментированными.

# Если вы используете режим подмены, то сдесь необходимо указать ID воронок и
# этапов (см. https://www.amocrm.ru/developers/content/crm_platform/leads_pipelines)
# В случае игорирования данный параметров, лиды будут созданы в вороронке по
# умолчанию в самом первом статусе.

MOCK_PIPELINE_BOOKED_ID=10156066
# MOCK_PIPELINE_MC_ID=10164486
# MOCK_PIPELINE_BOOKED_STATUS_ID=80453094
# MOCK_PIPELINE_MC_STATUS_ID=80512650
```

## Принцип работы
---

При *добавлении/обновлении* данных в **RDESK** (СПК Здравница), данные отправляются в **AmoCRM** , через данный сервис. Сервис выступает своего рода шлюзом для интеграции. Он обеспечивает трансформацию данных, а также осуществляет авторизацию ???????????? в **AmoCRM** .

 *Данные считаются добавленными/обновленными при формировании/изменения счета привязанного к карточке в Здравнице.*


## Внутреннее устройство
---
Данная интеграция состоит из 2 docker контейнеров: nginx (openresty) и rdesk-amo-sync(ссылка).

**Nginx** выступает в качестве обратного прокси. Также имеет вариант запуска с зеркалированием входящего трафика на сторонний сервер для тестирования.
**Rdesk-amo-sync** получает данные, трансформирует, отправляет с авторизацией в домен **AmoCRM**.
